<app-navbar></app-navbar>

<div class="detalle-container" *ngIf="!cargando && servicio">
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a routerLink="/">Inicio</a> > 
    <a routerLink="/servicios">Servicios</a> > 
    <span>{{ servicio.nombre }}</span>
  </div>

  <!-- Header del servicio -->
  <div class="servicio-header">
    <div class="servicio-imagen-principal">
      <img 
        [src]="servicio.imagen || 'https://via.placeholder.com/800x500?text=' + servicio.nombre" 
        [alt]="servicio.nombre"
      />
      <span class="categoria-badge">{{ servicio.categoria_nombre }}</span>
    </div>

    <div class="servicio-info-principal">
      <h1>{{ servicio.nombre }}</h1>
      
      <div class="proveedor-info">
        <h3>üè¢ {{ servicio.proveedor_nombre }}</h3>
      </div>

      <div class="valoracion-resumen" *ngIf="valoraciones.length > 0">
        <span class="estrellas">
          <ng-container *ngFor="let star of generarEstrellas(calcularPromedioValoraciones())">
            {{ star }}
          </ng-container>
        </span>
        <span class="promedio">{{ calcularPromedioValoraciones() }}</span>
        <span class="total">({{ valoraciones.length }} valoraciones)</span>
      </div>

      <div class="precio-principal">
        <span class="desde">Desde</span>
        <span class="valor">{{ servicio.precio }}‚Ç¨</span>
      </div>

      <div class="disponibilidad" [class.no-disponible]="!servicio.disponible">
        {{ servicio.disponible ? '‚úÖ Disponible' : '‚ùå No disponible' }}
      </div>

      <button 
        class="btn-reservar" 
        (click)="toggleFormularioReserva()"
        [disabled]="!servicio.disponible"
      >
        {{ mostrarFormularioReserva ? 'Cancelar' : 'Reservar Ahora' }}
      </button>
    </div>
  </div>

  <!-- Formulario de Reserva -->
  <div class="formulario-reserva" *ngIf="mostrarFormularioReserva">
    <h3>Solicitar Reserva</h3>
    
    <div *ngIf="reservaExitosa" class="mensaje-exito">
      ‚úÖ ¬°Reserva realizada con √©xito! Te contactaremos pronto.
    </div>

    <form *ngIf="!reservaExitosa" (ngSubmit)="realizarReserva()">
      <div class="form-group">
        <label>Fecha del evento:</label>
        <input 
          type="date" 
          [(ngModel)]="fechaEvento" 
          name="fechaEvento"
          required
          [min]="fechaMinima"
        />
      </div>

      <div class="form-group">
        <label>Comentarios adicionales:</label>
        <textarea 
          [(ngModel)]="comentarios" 
          name="comentarios"
          rows="4"
          placeholder="Cu√©ntanos m√°s sobre tu evento..."
        ></textarea>
      </div>

      <button 
        type="submit" 
        class="btn-enviar"
        [disabled]="reservaEnviando"
      >
        {{ reservaEnviando ? 'Enviando...' : 'Confirmar Reserva' }}
      </button>
    </form>
  </div>

  <!-- Descripci√≥n -->
  <div class="descripcion-completa">
    <h2>Descripci√≥n</h2>
    <p>{{ servicio.descripcion }}</p>
  </div>

  <!-- Valoraciones -->
  <div class="valoraciones-seccion">
    <div class="valoraciones-header">
      <h2>Valoraciones ({{ valoraciones.length }})</h2>
      <button class="btn-valorar" (click)="toggleFormularioValoracion()">
        {{ mostrarFormularioValoracion ? 'Cancelar' : '‚≠ê Dejar Valoraci√≥n' }}
      </button>
    </div>

    <!-- Formulario Nueva Valoraci√≥n -->
    <div class="formulario-valoracion" *ngIf="mostrarFormularioValoracion">
      <h3>Deja tu opini√≥n</h3>
      <form (ngSubmit)="enviarValoracion()">
        <div class="form-group">
          <label>Puntuaci√≥n:</label>
          <select [(ngModel)]="nuevaValoracion.puntuacion" name="puntuacion">
            <option [value]="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 estrellas)</option>
            <option [value]="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 estrellas)</option>
            <option [value]="3">‚≠ê‚≠ê‚≠ê (3 estrellas)</option>
            <option [value]="2">‚≠ê‚≠ê (2 estrellas)</option>
            <option [value]="1">‚≠ê (1 estrella)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Comentario:</label>
          <textarea 
            [(ngModel)]="nuevaValoracion.comentario" 
            name="comentario"
            rows="4"
            placeholder="Comparte tu experiencia..."
            required
          ></textarea>
        </div>

        <button 
          type="submit" 
          class="btn-enviar"
          [disabled]="valoracionEnviando"
        >
          {{ valoracionEnviando ? 'Enviando...' : 'Publicar Valoraci√≥n' }}
        </button>
      </form>
    </div>

    <!-- Lista de Valoraciones -->
    <div class="valoraciones-lista">
      <div class="valoracion-item" *ngFor="let val of valoraciones">
        <div class="valoracion-header">
          <strong>{{ val.usuario_nombre }}</strong>
          <span class="estrellas">
            <ng-container *ngFor="let star of generarEstrellas(val.puntuacion)">
              {{ star }}
            </ng-container>
          </span>
        </div>
        <p class="valoracion-comentario">{{ val.comentario }}</p>
        <span class="valoracion-fecha">{{ val.fecha | date:'dd/MM/yyyy' }}</span>
      </div>

      <p *ngIf="valoraciones.length === 0" class="sin-valoraciones">
        A√∫n no hay valoraciones. ¬°S√© el primero en opinar!
      </p>
    </div>
  </div>

  <!-- Bot√≥n volver -->
  <div class="acciones-footer">
    <button class="btn-volver" routerLink="/servicios">
      ‚Üê Volver a Servicios
    </button>
  </div>
</div>

<div class="loading" *ngIf="cargando">
  <p>Cargando servicio...</p>
</div>